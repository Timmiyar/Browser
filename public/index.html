<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aurora Browser</title>
  <link rel="stylesheet" href="browser.css">
  <link rel="shortcut icon" href="favicon.ico">
  <script src="/scram/scramjet.all.js"></script>
  <script src="baremux/index.js" defer></script>
  <script src="epoxy/index.js" defer></script>
  <script src="register-sw.js" defer></script>
  <script src="browser.js" defer></script>
  <!-- Cloudflare Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>
  <!-- Turnstile Verification Overlay (shown on first load) -->
  <div id="turnstile-overlay" class="turnstile-overlay">
    <div class="turnstile-container">
      <div class="turnstile-header">
        <h2>üõ°Ô∏è Aurora Browser Security Check</h2>
        <p>Please verify you're human to continue</p>
      </div>
      <div id="turnstile-widget" class="cf-turnstile" 
           data-sitekey="0x4AAAAAACFRVcvtMLdE9Ake"
           data-callback="onTurnstileSuccess"
           data-error-callback="onTurnstileError"
           data-theme="dark"
           data-size="normal">
      </div>
      <div id="turnstile-status" class="turnstile-status"></div>
    </div>
  </div>

  <!-- Browser UI (hidden until verification) -->
  <div id="browser-ui" style="display: none;">
    <!-- Browser Chrome UI -->
    <div class="browser-container">
      <!-- Title Bar -->
      <div class="title-bar">
        <div class="window-controls">
          <span class="window-btn close"></span>
          <span class="window-btn minimize"></span>
          <span class="window-btn maximize"></span>
        </div>
        <div class="title-text">Aurora Browser</div>
        <div class="menu-bar">
          <button id="menu-btn" class="menu-btn" title="Menu">‚ò∞</button>
        </div>
      </div>

      <!-- Tab Bar -->
      <div class="tab-bar">
        <div class="tabs" id="tabs-container">
          <!-- Tabs go here -->
        </div>
        <!-- New tab button moved inside tabs-container via JS -->
      </div>

      <!-- Navigation Bar -->
      <div class="nav-bar">
        <div class="nav-buttons">
          <button id="back-btn" class="nav-btn" title="Back (Alt+‚Üê)" disabled>‚Üê</button>
          <button id="forward-btn" class="nav-btn" title="Forward (Alt+‚Üí)" disabled>‚Üí</button>
          <button id="refresh-btn" class="nav-btn" title="Refresh (F5)">‚Üª</button>
          <button id="home-btn" class="nav-btn" title="Home">üè†</button>
        </div>
        <div class="url-bar-container">
          <span class="url-protocol" id="url-protocol">aurora://</span>
          <input type="text" id="url-bar" class="url-bar" placeholder="Search or enter URL" autocomplete="off">
          <button id="go-btn" class="go-btn" title="Go">‚Üí</button>
        </div>
        <div class="toolbar-buttons">
          <div id="extensions-toolbar"></div>
          <button id="extensions-btn" class="toolbar-btn" title="Extensions">üß©</button>
          <button id="bookmark-btn" class="toolbar-btn" title="Bookmark this page">‚òÜ</button>
          <button id="devtools-btn" class="toolbar-btn" title="DevTools (F12)">‚öô</button>
          <button id="settings-btn" class="toolbar-btn" title="Settings">‚ãÆ</button>
        </div>
      </div>

      <!-- Bookmarks Bar -->
      <div class="bookmarks-bar" id="bookmarks-bar">
        <span class="bookmarks-label">Bookmarks:</span>
        <div class="bookmarks-list" id="bookmarks-list">
          <!-- Bookmarks will be added dynamically -->
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="main-content" id="main-content">
        <!-- Browser Frame Container -->
        <div class="browser-frame-container" id="browser-frame-container">
          <!-- Frames will be added dynamically for each tab -->
        </div>

        <!-- Home Page -->
        <div class="home-page" id="home-page">
          <div class="home-logo">
            <div class="aurora-logo">üåå</div>
            <h1>Aurora Browser</h1>
          </div>
          <div class="search-container">
            <input type="text" id="home-search" class="home-search" placeholder="Search or enter URL">
            <button id="home-search-btn" class="home-search-btn">Search</button>
          </div>
          <div class="quick-links">
            <h3>Quick Links</h3>
            <div class="quick-links-grid">
              <a href="#" class="quick-link" data-url="aurora://chat">
                <span class="quick-link-icon">üí¨</span>
                <span class="quick-link-text">Chat</span>
              </a>
              <a href="#" class="quick-link" data-url="aurora://post">
                <span class="quick-link-icon">üìù</span>
                <span class="quick-link-text">Post</span>
              </a>
              <a href="#" class="quick-link" data-url="aurora://bookmarks">
                <span class="quick-link-icon">‚≠ê</span>
                <span class="quick-link-text">Bookmarks</span>
              </a>
              <a href="#" class="quick-link" data-url="aurora://history">
                <span class="quick-link-icon">üïí</span>
                <span class="quick-link-text">History</span>
              </a>
              <a href="#" class="quick-link" data-url="aurora://settings">
                <span class="quick-link-icon">‚öôÔ∏è</span>
                <span class="quick-link-text">Settings</span>
              </a>
            </div>
          </div>
        </div>

        <!-- Settings Page -->
        <div class="settings-page hidden" id="settings-page">
          <div class="settings-container">
            <h1>‚öôÔ∏è Settings</h1>
            
            <section class="settings-section">
              <h2>Search Engine</h2>
              <div class="setting-group">
                <label for="search-engine">Default Search Engine:</label>
                <select id="search-engine">
                  <option value="https://www.google.com/search?q=%s">Google</option>
                  <option value="https://duckduckgo.com/?q=%s">DuckDuckGo</option>
                  <option value="https://www.bing.com/search?q=%s">Bing</option>
                  <option value="https://search.yahoo.com/search?p=%s">Yahoo</option>
                </select>
              </div>
            </section>
            
            <section class="settings-section">
              <h2>Appearance</h2>
              <div class="setting-group">
                <label for="theme">Theme:</label>
                <select id="theme">
                  <option value="dark">Dark</option>
                  <option value="light">Light</option>
                  <option value="midnight">Midnight</option>
                  <option value="ocean">Ocean</option>
                  <option value="forest">Forest</option>
                </select>
              </div>
              <div class="setting-group">
                <label>
                  <input type="checkbox" id="show-bookmarks-bar" checked>
                  Show Bookmarks Bar
                </label>
              </div>
            </section>
            
            <section class="settings-section">
              <h2>Data Management</h2>
              <button id="clear-history" class="settings-btn danger">Clear History</button>
              <button id="clear-bookmarks" class="settings-btn danger">Clear Bookmarks</button>
              <button id="reset-settings" class="settings-btn danger">Reset All Settings</button>
            </section>
            
            <section class="settings-section">
              <h2>Keyboard Shortcuts</h2>
              <div class="shortcuts-list">
                <div class="shortcut"><kbd>Ctrl</kbd> + <kbd>T</kbd> New Tab</div>
                <div class="shortcut"><kbd>Ctrl</kbd> + <kbd>W</kbd> Close Tab</div>
                <div class="shortcut"><kbd>Ctrl</kbd> + <kbd>L</kbd> Focus URL Bar</div>
                <div class="shortcut"><kbd>Alt</kbd> + <kbd>‚Üê</kbd> Back</div>
                <div class="shortcut"><kbd>Alt</kbd> + <kbd>‚Üí</kbd> Forward</div>
                <div class="shortcut"><kbd>F5</kbd> Refresh</div>
                <div class="shortcut"><kbd>F12</kbd> DevTools</div>
                <div class="shortcut"><kbd>Ctrl</kbd> + <kbd>D</kbd> Bookmark Page</div>
                <div class="shortcut"><kbd>Ctrl</kbd> + <kbd>H</kbd> History</div>
                <div class="shortcut"><kbd>Ctrl</kbd> + <kbd>B</kbd> Bookmarks</div>
              </div>
            </section>
            
            <section class="settings-section">
              <h2>About Aurora</h2>
              <p>Aurora Browser v1.0.0</p>
              <p>A sophisticated web proxy browser built on Scramjet technology.</p>
              <p style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">Copyright 2025 Firewall Freedom by Sirco</p>
            </section>
          </div>
        </div>

        <!-- Extensions Page -->
        <div class="extensions-page hidden" id="extensions-page">
          <div class="settings-container">
            <h1>üß© Extensions</h1>
            
            <div class="settings-section">
              <h3>Install Extension</h3>
              <p style="color: var(--text-secondary); margin-bottom: 10px;">Paste the extension code (including METADATA) below:</p>
              <textarea id="extension-code-input" class="settings-input" style="width: 100%; height: 150px; font-family: monospace; margin-bottom: 10px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 10px; border-radius: 4px;" placeholder="/*METADATA*/ ..."></textarea>
              <button id="install-code-btn" class="settings-btn primary">Install Extension</button>
            </div>

            <div class="settings-section">
              <h3>Installed Extensions</h3>
              <div id="extensions-list" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                <!-- Extensions list -->
              </div>
            </div>
          </div>
        </div>

        <!-- History Page -->
        <div class="history-page hidden" id="history-page">
          <div class="history-container">
            <h1>üïí History</h1>
            <button id="clear-all-history" class="settings-btn danger">Clear All History</button>
            <div class="history-list" id="history-list">
              <!-- History items will be added dynamically -->
            </div>
          </div>
        </div>

        <!-- Bookmarks Page -->
        <div class="bookmarks-page hidden" id="bookmarks-page">
          <div class="bookmarks-container">
            <h1>‚≠ê Bookmarks</h1>
            <div class="bookmarks-full-list" id="bookmarks-full-list">
              <!-- Bookmark items will be added dynamically -->
            </div>
          </div>
        </div>
      </div>

      <!-- DevTools Panel -->
      <div class="devtools-panel hidden" id="devtools-panel">
        <div class="devtools-header">
          <div class="devtools-tabs">
            <button class="devtools-tab active" data-panel="elements">Elements</button>
            <button class="devtools-tab" data-panel="console">Console</button>
            <button class="devtools-tab" data-panel="network">Network</button>
            <button class="devtools-tab" data-panel="sources">Sources</button>
            <button class="devtools-tab" data-panel="application">Application</button>
          </div>
          <button id="close-devtools" class="close-devtools">√ó</button>
        </div>
        <div class="devtools-content">
          <div class="devtools-pane active" id="devtools-elements">
            <div class="elements-tree" id="elements-tree">
              <p class="devtools-info">Select an element in the page to inspect it.</p>
              <div id="dom-tree"></div>
            </div>
            <div class="elements-styles">
              <h4>Styles</h4>
              <div id="element-styles"></div>
            </div>
          </div>
          <div class="devtools-pane" id="devtools-console">
            <div class="console-output" id="console-output">
              <!-- Console messages will be added here -->
            </div>
            <div class="console-input-container">
              <span class="console-prompt">&gt;</span>
              <input type="text" id="console-input" class="console-input" placeholder="Type JavaScript here...">
            </div>
          </div>
          <div class="devtools-pane" id="devtools-network">
            <div class="network-toolbar">
              <button id="clear-network" class="devtools-btn">Clear</button>
              <label><input type="checkbox" id="preserve-log"> Preserve log</label>
            </div>
            <div class="network-list-header">
              <span class="network-col">Name</span>
              <span class="network-col">Status</span>
              <span class="network-col">Type</span>
              <span class="network-col">Size</span>
              <span class="network-col">Time</span>
            </div>
            <div class="network-list" id="network-list">
              <!-- Network requests will be added here -->
            </div>
          </div>
          <div class="devtools-pane" id="devtools-sources">
            <div class="sources-sidebar">
              <h4>Page Sources</h4>
              <div id="sources-list"></div>
            </div>
            <div class="sources-content">
              <pre id="source-code"></pre>
            </div>
          </div>
          <div class="devtools-pane" id="devtools-application">
            <div class="application-sidebar">
              <h4>Storage</h4>
              <ul>
                <li class="app-item" data-type="localStorage">Local Storage</li>
                <li class="app-item" data-type="sessionStorage">Session Storage</li>
                <li class="app-item" data-type="cookies">Cookies</li>
              </ul>
            </div>
            <div class="application-content" id="application-content">
              <p class="devtools-info">Select a storage type to view its contents.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Turnstile Integration
    let turnstileToken = sessionStorage.getItem('aurora_turnstile_token');
    let turnstileExpiry = sessionStorage.getItem('aurora_turnstile_expiry');

    // Check server status for Dev Mode bypass
    fetch('/api/status')
      .then(res => res.json())
      .then(data => {
        if (data.devMode) {
          console.log('[Turnstile] Dev Mode detected - Bypassing verification');
          hideTurnstileOverlay();
        }
      })
      .catch(e => console.error('Failed to check status:', e));

    // Check if we have a valid token
    if (turnstileToken && turnstileExpiry && Date.now() < parseInt(turnstileExpiry)) {
      // Token is still valid, skip verification
      hideTurnstileOverlay();
    }

    function onTurnstileSuccess(token) {
      console.log('[Turnstile] Verification successful');
      
      // Verify token with server
      fetch('/api/verify-turnstile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Store token for 30 minutes
          sessionStorage.setItem('aurora_turnstile_token', token);
          sessionStorage.setItem('aurora_turnstile_expiry', Date.now() + (30 * 60 * 1000));
          
          document.getElementById('turnstile-status').innerHTML = '‚úÖ Verified! Loading browser...';
          setTimeout(hideTurnstileOverlay, 1000);
        } else {
          document.getElementById('turnstile-status').innerHTML = '‚ùå Verification failed. Please try again.';
          setTimeout(() => window.turnstile.reset(), 2000);
        }
      })
      .catch(err => {
        console.error('[Turnstile] Verification error:', err);
        document.getElementById('turnstile-status').innerHTML = '‚ùå Network error. Please refresh.';
      });
    }

    function onTurnstileError(error) {
      console.error('[Turnstile] Widget error:', error);
      document.getElementById('turnstile-status').innerHTML = '‚ö†Ô∏è Verification error. Please refresh the page.';
    }

    function hideTurnstileOverlay() {
      document.getElementById('turnstile-overlay').style.display = 'none';
      document.getElementById('browser-ui').style.display = 'block';
    }

    // Refresh token before expiry
    setInterval(() => {
      const expiry = sessionStorage.getItem('aurora_turnstile_expiry');
      if (expiry && Date.now() > parseInt(expiry) - (5 * 60 * 1000)) {
        // Token expires in less than 5 minutes, refresh it silently
        if (window.turnstile) {
          turnstile.render('#turnstile-widget', {
            sitekey: '0x4AAAAAACFRVcvtMLdE9Ake',
            callback: onTurnstileSuccess,
            theme: 'dark',
            size: 'invisible'
          });
        }
      }
    }, 60000); // Check every minute
  </script>

  <!-- Context Menu -->
  <div id="context-menu" class="context-menu hidden">
    <div class="context-menu-item" data-action="new_tab">New Tab</div>
    <div class="context-menu-item" data-action="reload">Reload</div>
    <div class="context-menu-item" data-action="close">Close Tab</div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="incognito">Toggle Incognito</div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" data-action="settings">Settings</div>
    <div class="context-menu-item" data-action="help">Help</div>
  </div>

  <!-- Main Menu -->
  <div id="main-menu" class="main-menu hidden">
    <div class="menu-section">
      <div class="menu-item" data-action="file-new">New Tab <span class="shortcut">Ctrl+T</span></div>
      <div class="menu-item" data-action="file-incognito">New Incognito Window</div>
    </div>
    <div class="menu-separator"></div>
    <div class="menu-section">
      <div class="menu-item" data-action="edit-undo">Undo <span class="shortcut">Ctrl+Z</span></div>
      <div class="menu-item" data-action="edit-redo">Redo <span class="shortcut">Ctrl+Y</span></div>
    </div>
    <div class="menu-separator"></div>
    <div class="menu-section">
      <div class="menu-item" data-action="view-reload">Reload <span class="shortcut">F5</span></div>
      <div class="menu-item" data-action="view-home">Home</div>
      <div class="menu-item" data-action="devtools">Developer Tools <span class="shortcut">F12</span></div>
    </div>
    <div class="menu-separator"></div>
    <div class="menu-section">
      <div class="menu-item" data-action="settings">Settings</div>
      <div class="menu-item" data-action="help">Help</div>
      <div class="menu-item" data-action="about">About Aurora</div>
    </div>
  </div>

  <!-- Bookmark Dialog -->
  <div id="bookmark-dialog-overlay" class="dialog-overlay hidden">
    <div class="dialog-box">
      <h3>Add Bookmark</h3>
      <div class="dialog-content">
        <div class="form-group">
          <label for="bookmark-name">Name</label>
          <input type="text" id="bookmark-name" class="dialog-input">
        </div>
        <div class="form-group">
          <label for="bookmark-url">URL</label>
          <input type="text" id="bookmark-url" class="dialog-input">
        </div>
      </div>
      <div class="dialog-actions">
        <button id="bookmark-cancel" class="dialog-btn secondary">Cancel</button>
        <button id="bookmark-save" class="dialog-btn primary">Save</button>
      </div>
    </div>
  </div>
</body>
</html>
